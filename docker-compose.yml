version: '3.8'

services:
  # ============================================
  # Infrastructure Services
  # ============================================
  
  postgres:
    image: postgres:16-alpine
    container_name: gramsetu-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-gramsetu}
      POSTGRES_USER: ${POSTGRES_USER:-gramsetu_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-gramsetu_pass}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-gramsetu_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gramsetu-network

  redis:
    image: redis:7-alpine
    container_name: gramsetu-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-gramsetu_redis}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gramsetu-network

  # ============================================
  # Member 1: Voice Service
  # ============================================
  
  voice-service:
    build:
      context: .
      dockerfile: services/voice/Dockerfile
    container_name: gramsetu-voice
    environment:
      - BHASHINI_API_KEY=${BHASHINI_API_KEY}
      - BHASHINI_USER_ID=${BHASHINI_USER_ID}
      - SARVAM_API_KEY=${SARVAM_API_KEY}
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD:-gramsetu_redis}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8001:8000"
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./services/voice:/app
      - voice_models:/models
    networks:
      - gramsetu-network
    restart: unless-stopped

  # ============================================
  # Member 2: Agent Service
  # ============================================
  
  agent-service:
    build:
      context: .
      dockerfile: services/agent/Dockerfile
    container_name: gramsetu-agent
    environment:
      - AWS_REGION=${AWS_REGION:-ap-south-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - BEDROCK_AGENT_ID=${BEDROCK_AGENT_ID}
      - BEDROCK_MODEL_ID=${BEDROCK_MODEL_ID}
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD:-gramsetu_redis}
      - HEADLESS_BROWSER=${HEADLESS_BROWSER:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8002:8000"
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./services/agent:/app
      - browser_data:/browser-data
    networks:
      - gramsetu-network
    restart: unless-stopped
    # Increase shared memory for browser
    shm_size: 2gb

  # ============================================
  # Member 3: Document Service
  # ============================================
  
  document-service:
    build:
      context: .
      dockerfile: services/document/Dockerfile
    container_name: gramsetu-document
    environment:
      - AWS_REGION=${AWS_REGION:-ap-south-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD:-gramsetu_redis}
      - AADHAAR_MASK_DIGITS=${AADHAAR_MASK_DIGITS:-8}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8003:8000"
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./services/document:/app
      - document_storage:/storage
    networks:
      - gramsetu-network
    restart: unless-stopped

  # ============================================
  # Member 4: Orchestrator Service
  # ============================================
  
  orchestrator:
    build:
      context: .
      dockerfile: services/orchestrator/Dockerfile
    container_name: gramsetu-orchestrator
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-gramsetu}
      - POSTGRES_USER=${POSTGRES_USER:-gramsetu_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-gramsetu_pass}
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD:-gramsetu_redis}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_WHATSAPP_NUMBER=${TWILIO_WHATSAPP_NUMBER}
      - SECRET_KEY=${SECRET_KEY}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/orchestrator:/app
    networks:
      - gramsetu-network
    restart: unless-stopped

  # ============================================
  # Celery Worker (Background Jobs)
  # ============================================
  
  celery-worker:
    build:
      context: .
      dockerfile: services/orchestrator/Dockerfile
    container_name: gramsetu-celery
    command: celery -A services.orchestrator.worker worker --loglevel=info
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=${POSTGRES_DB:-gramsetu}
      - POSTGRES_USER=${POSTGRES_USER:-gramsetu_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-gramsetu_pass}
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD:-gramsetu_redis}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/orchestrator:/app
    networks:
      - gramsetu-network
    restart: unless-stopped

  # ============================================
  # Monitoring (Optional for Hackathon)
  # ============================================
  
  # redis-commander:
  #   image: rediscommander/redis-commander:latest
  #   container_name: gramsetu-redis-ui
  #   environment:
  #     - REDIS_HOSTS=local:redis:6379:0:${REDIS_PASSWORD:-gramsetu_redis}
  #   ports:
  #     - "8081:8081"
  #   depends_on:
  #     - redis
  #   networks:
  #     - gramsetu-network

volumes:
  postgres_data:
  redis_data:
  voice_models:
  browser_data:
  document_storage:

networks:
  gramsetu-network:
    driver: bridge
